apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"
apply plugin: "com.facebook.react"

/**
 * Configurazione React Native per l'app Android.
 * Usiamo il plugin ufficiale "com.facebook.react".
 */
react {
    /* Autolinking */
    autolinkLibrariesWithApp()
}

/**
 * Disabilitiamo esplicitamente HERMES per questa app.
 * In questo modo React Native user√† JSC come motore JS.
 */
project.ext.react = [
        enableHermes: false
]

/**
 * Proguard solo sulle build release (per ora disattivato).
 */
def enableProguardInReleaseBuilds = false

/**
 * Motore JavaScript: usiamo JSC classico, NON Hermes.
 */
def jscFlavor = 'org.webkit:android-jsc:+'

/**
 * --------------------------------------------------
 * Caricamento credenziali firma RELEASE
 * --------------------------------------------------
 * Preferito: android/keystore.properties (NON committare)
 *
 * Contenuto previsto:
 * storeFile=../keystores/voiceguideairlink-upload.jks
 * storePassword=...
 * keyAlias=voiceguideairlink
 * keyPassword=...
 *
 * Fallback: variabili ambiente
 * ANDROID_KEYSTORE_FILE, ANDROID_KEYSTORE_PASSWORD,
 * ANDROID_KEY_ALIAS, ANDROID_KEY_PASSWORD
 */
def keystoreProperties = new Properties()
def keystorePropertiesFile = rootProject.file("keystore.properties")
if (keystorePropertiesFile.exists()) {
    keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
}

android {
    ndkVersion rootProject.ext.ndkVersion
    buildToolsVersion rootProject.ext.buildToolsVersion
    compileSdk rootProject.ext.compileSdkVersion

    namespace "com.voiceguideairlinkbare"

    defaultConfig {
        // ‚úÖ ID definitivo per Google Play
        applicationId "com.voiceguideairlinkbare"

        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion

        // üîÅ Incrementare ad ogni upload su Play
        versionCode 4
        versionName "1.0.3"

        // üîΩ FORZIAMO SOLO ARM64 PER DIMAGRIRE L'APK
        ndk {
            abiFilters "arm64-v8a"
        }
    }

    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }

        release {
            // ‚úÖ Non hardcodiamo password nel repo.
            // Usa keystore.properties oppure ENV.
            def sf = keystoreProperties['storeFile'] ?: System.getenv("ANDROID_KEYSTORE_FILE")
            def sp = keystoreProperties['storePassword'] ?: System.getenv("ANDROID_KEYSTORE_PASSWORD")
            def ka = keystoreProperties['keyAlias'] ?: System.getenv("ANDROID_KEY_ALIAS")
            def kp = keystoreProperties['keyPassword'] ?: System.getenv("ANDROID_KEY_PASSWORD")

            if (sf != null && sp != null && ka != null && kp != null) {
                storeFile file(sf)
                storePassword sp
                keyAlias ka
                keyPassword kp
            }
        }
    }

    buildTypes {
        debug {
            // ‚úÖ debug separato: com.voiceguideairlinkbare.dev
            applicationIdSuffix ".dev"
            signingConfig signingConfigs.debug
        }

        release {
            // ‚úÖ release firmata con keystore di upload
            signingConfig signingConfigs.release
            minifyEnabled enableProguardInReleaseBuilds
            proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
        }
    }
}

dependencies {
    // Versione di react-android gestita dal plugin React Native
    implementation("com.facebook.react:react-android")

    // ‚úÖ FORZIAMO JSC, NIENTE HERMES
    implementation jscFlavor
}
